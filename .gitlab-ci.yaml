workflow:
  rules:
    - if: $CI_MERGE_REQUEST_TITLE =~ /^(\[Draft\]|\(Draft\)|Draft:|\[WIP\]|WIP:)/
      when: never
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      # trigger on tag
    - if: '$CI_COMMIT_TAG =~ /^5.3.*/ || $CI_COMMIT_TAG =~ /^m5.3.*/'
    - if: $CI_PIPELINE_SOURCE == "web"

stages:
  - builder
  - test
  - build
  - image

variables:
  CLICOLOR_FORCE: '1'
  GIT_SUBMODULE_STRATEGY: recursive
  # NPM_PROXY: '1'
  CI_IMAGE_NAME: docker.frafos.net/debian/moki-ci:5.3

include:
  - .gitlab-ci/template.yaml

docker:ci:
  stage: builder
  image: docker.frafos.net/docker:20.10-ci
  interruptible: true
  rules:
    - changes:
      - Dockerfile.ci
  services:
  - name: docker.frafos.net/docker:20.10-dind
    alias: docker
  script:
    - docker build -f Dockerfile.ci -t $CI_IMAGE_NAME .
    - docker push $CI_IMAGE_NAME

client:lint:
  stage: test
  extends: .lint
  variables:
    WHERE: Moki/client

server:lint:
  stage: test
  extends: .lint
  needs:
    - job: docker:ci
      optional: true
  variables:
    WHERE: Moki/server

client:test:
  stage: test
  extends: .test
  needs:
    - job: docker:ci
      optional: true
  variables:
    WHERE: Moki/client

server:test:
  stage: test
  extends: .test
  needs:
    - job: docker:ci
      optional: true
  variables:
    WHERE: Moki/server

client:build:
  stage: build
  image: $CI_IMAGE_NAME
  interruptible: true
  script:
    - npm install --prefix Moki/client --omit-dev
    - npm run build --prefix Moki/client
  needs:
    - client:test
    - client:lint
    - job: docker:ci
      optional: true
  rules:
    - if: $CI_MERGE_REQUEST_LABELS =~ /^(.*,)?ci-skip-tests(,.*)*$/
      when: never
    - changes:
        - Moki/client/*
        - Moki/client/**/*

server:build:
  stage: build
  image: $CI_IMAGE_NAME
  interruptible: true
  script:
    - npm install --prefix Moki/server --omit-dev
    - npm run build --prefix Moki/server
  needs:
    - server:test
    - server:lint
    - job: docker:ci
      optional: true
  rules:
    - if: $CI_MERGE_REQUEST_LABELS =~ /^(.*,)?ci-skip-tests(,.*)*$/
      when: never
    - changes:
        - Moki/server/*
        - Moki/server/**/*

docker:dist:
  stage: build
  needs:
    - job: docker:ci
      optional: true
  image: $CI_IMAGE_NAME
  script:
    - make install DESTDIR=`pwd`/dist
  artifacts:
    expire_in: 1h
    paths:
      - dist

docker:overlay:
  stage: image
  image: docker.frafos.net/docker:23.0-ci
  interruptible: true
  needs:
    - docker:dist
  services:
  - name: docker.frafos.net/docker:23.0-dind
    alias: docker
  script:
    - make pull-base pull-build
    - |
      if test "$CI_MERGE_REQUEST_IID" -o "$CI_COMMIT_REF_NAME" != "$CI_DEFAULT_BRANCH" ; then
        export VERSION=`make get_tag TAG=$CI_COMMIT_REF_NAME`
      fi
    - echo "Image version is $VERSION"
    - make overlay push
